<% 
  @users.each do |id| 
    user = data_bag_item('daris_users', id)
    if user['groups'].member?(@user_group) then
      role_args = user['roles'].map { |r| ":role #{r}" }.join(" ")
      names = user['names'] || []
      name_args = [0..names.length-1].map(|i|
	  type = (switch i 
                  when 0
                    'first' 
                  when (names.length - 1) 
                    'last' 
                  else 
                    'middle')
	  ":name -type #{type} #{names[i]}").join(" ")
%>
      om.pssd.user.create :user <%= user['user'] || user['id'] %> \
          :authority local \
          :domain <%= @domain %> \
	  :email <%= user['email'] || "nobody@nowhere" %> \
	  :password <%= user['password'] || "secret" %> \
	  :project-creator <%= user['project_creator'] || false %> \
	  <%= name_args %> \
          <%= role_args %> \
<%
    end
  end
%>